{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<script type="text/javascript" src="{% static "js/timer/jquery.countdown.js" %}"></script>
<script type="text/javascript" src="{% static "js/timer/jquery.countdown.min.js" %}"></script>
<link rel="stylesheet" type="text/css" href="{% static "css/landing_page.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "css/stars.css" %}">
<script src="{% static "js/landing_page.js" %}"></script>
{% endblock extra_head %}

{% block title_splash %}
{% endblock title_splash %}

{% block mainbody %}
<div class="mainBody container">
    <div class="row selection-header sticky-top">
        <div class="col">
            <form id="test_form" class="form-inline row selection-header">
                <div class="d-none d-md-inline-block col-xl-4 col-md-5">
                    <div class="dropdown show d-inline-block">
                        <a class="btn btn-sm btn-dark dropdown-toggle" href="#" role="button" id="dropdownFilterLink"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Filters
                        </a>
                        <div class="dropdown-menu dropdown-menu-custom" aria-labelledby="dropdownFilterLink">
                            <div class="filter-dropdown-container container row">
                                <div class="col-4">
                                    <div class="filter-category-title">Classes</div>
                                    <div name="classes" class="filter-container custom-scroll-bar">
                                        {% for class in wowclasses %}
                                        <div name="{{class.name}}" class="filter-box">{{class.name}}</div>
                                        {%endfor%}
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="filter-category-title">Professions</div>
                                    <div name="professions" class="filter-container custom-scroll-bar">
                                        {% for profession in wowprofessions %}
                                        <div name="{{profession.name}}" class="filter-box">{{profession.name}}</div>
                                        {%endfor%}
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="filter-category-title">Tags</div>
                                    <div name="tags" class="filter-container custom-scroll-bar">
                                        {% for tag in tags %}
                                        <div name="{{tag.name}}" class="filter-box">{{tag.name}}</div>
                                        {%endfor%}
                                    </div>
                                </div>
                                <div class="col-12 justify-content-around mt-2">
                                    <button class="btn btn-sm btn-dark" id="reset-filters" type="button">Reset</button>
                                    <button class="btn btn-sm btn-dark" id="apply-filters" type="button">Apply Filters</button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="dropdown show d-inline-block">
                        <a class="btn btn-sm btn-dark dropdown-toggle" href="#" role="button" id="sorting"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Sort
                        </a>
                        <div class="dropdown-menu dropdown-menu-custom sortby-dropdown" aria-labelledby="sorting">
                            <a class="dropdown-item sorting-item" href="#">Rating</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item sorting-item" href="#">Created</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item sorting-item" href="#">Updated</a>
                        </div>
                        <a id="sorting_order" class="btn btn-sm untouchable hidden">
                            <span class="glyphicon glyphicon-triangle-bottom untouchable"></span>
                        </a>
                    </div>
                </div>
                <div class="col-12 col-xl-8 col-md-7">
                    <input id="search_bar" class="form-control form-control-sm" type="search" placeholder="Search Keywords" size="30" aria-label="Search">
                    <button id="search_bar_button" class="btn btn-sm btn-outline-warning" type="submit">Search</button>
                </div>
            </form>
        </div>
    </div>
    <div class="row content-container mt-4">
        <div class="applied-filter-container mx-auto col-12"></div>
        <div id="saved_list_container" class="mx-auto">
            {% include "index_helper.html" %}
        </div>

    </div>
</div>
</div>

{% endblock mainbody %}

{% block footer %}
{# "not necessary, here to demonstrate block.super" #}
{{block.super}}
{% endblock footer %}

{% block javascript %}
<script>

$(document).ready(function() {
    index_handlers()

 });

 function index_handlers() {
     $("#test_form").on({
         submit: e => {
             console.log("#test_form submit")
             e.preventDefault()
             // e.stopPropagation()
         }
     });

     $('.filter-dropdown-container').on({
         click: e => {
             console.log(".filter-dropdown-container click")
             e.stopPropagation()
         }
     });
     $('.filter-box').on({
         click: e => {
             e.stopPropagation()
             console.log(".filter-box click")
             var target = $(e.target)
             // add target[0].innerText   to an array to be sent with apply filters
             if (target.hasClass('filter-selected')) {
                 target.removeClass('filter-selected')
             } else {
                 target.addClass('filter-selected')
             }
         }
     });
     // $("#search_bar_button").on({
     //     submit: e=> {
     //         e.preventDefault()
     //         e.stopImmediatePropagation()
     //
     //         console.log('#search_bar_button submit')
     //         search_daddy()
     //     },
     //     click: e=> {
     //         e.preventDefault()
     //         e.stopImmediatePropagation()
     //         console.log('#search_bar_button click')
     //         search_daddy()
     //     }
     // });

     $("#search_bar").on({
         search: e=> {
             e.stopImmediatePropagation()
             console.log('#search_bar search')
             yeet_cannon()
         }
     });

     $("#apply-filters, #search_bar_button").on({
         click: e => {
             console.log('#apply-filters click')
             e.preventDefault()

             yeet_cannon()

             $('.dropdown-menu').removeClass('show')

             let tags = $.map($(".filter-selected"), x => x.innerText).join(", ")

             // let filterArray = []
             // let selectedFilters = $('.filter-selected')
             // for (const filter of selectedFilters) {
             //     filterArray.push(filter.innerText)
             // }
             // let displayFilters = filterArray.toString().replace(/,/g, ', ')

             $('.applied-filter-container').text(`Applied Filters: ${tags}`)
         }
     });

     $('#reset-filters').on({
         click: e => {
             console.log('#reset-filters click')

             e.preventDefault()
             e.stopImmediatePropagation()
             $('.filter-selected').removeClass('filter-selected')

             let tags = $.map($(".filter-selected"), x => x.innerText)

             yeet_cannon()
             $('.applied-filter-container').text(tags)
         },
         submit: e => {
             e.preventDefault()
         }
     });

     $('.sorting-item').on({
         click: e => {
             // e.preventDefault()
             let sortBySelection = $(e.target).text()
             console.log($(e.target))
             $('#sorting').text(sortBySelection)
             console.log($(e.target).text())
             let sort_order = $("#sorting_order")
             sort_order.removeClass("hidden").removeClass("untouchable")
             sort_order.find("span.glyphicon").removeClass("glyphicon-triangle-top").addClass("glyphicon-triangle-bottom")
             // add sorting function here
             yeet_cannon()

         }
     });

     $("#sorting_order").on({
         click: e=> {
             console.log('#sorting_order')
             let sort_order = $(e.target).find("span.glyphicon")
             if (sort_order.hasClass("glyphicon-triangle-bottom")) {
                 sort_order.removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-top")
             } else {
                 sort_order.removeClass("glyphicon-triangle-top").addClass("glyphicon-triangle-bottom")
             }
             yeet_cannon()
         }
     })

     $(".glyphicon-star-empty").on({
         mouseenter: e => {
             var target = $(e.target)
             var empty_stars = target.closest($("div.longbar")).find($(".glyphicon-star-empty"))
             var index = empty_stars.index(target) + 1
             for (var i = 0; i < index; i++) {
                 $(empty_stars[i]).removeClass("glyphicon-star-empty").addClass("glyphicon-star gold")
             }
         },
         mouseleave: e => {
             let target = $(e.target)
             let longbar = target.closest($("div.longbar"))
             let stars = longbar.find($(".glyphicon"))
             stars.removeClass("glyphicon-star gold").addClass("glyphicon-star-empty")
         },
         mousedown: e => {
             // need some sort of confirmation here

             var target = $(e.target)
             let longbar = target.closest($("div.longbar"))
             let stars = longbar.find($(".glyphicon"))
             stars.unbind()
             var rating = longbar.find($(".glyphicon-star")).length
             var container = target.closest($(".ratings-container"))
             var id = container.attr("data-id")
             var wow_class = (container.attr("data-wowclass")) ? container.attr("data-wowclass") : 0
             var data = {
                 wow_class: wow_class,
                 id: id,
                 rating: rating
             }
             rate_saved_list(data)
         }
     });

 }



     function yeet_cannon() {
         var separator = /(?:\s|\,|\.)/
         var search_string = $("#search_bar").val()
         var words = search_string.split(separator).filter(Boolean).filter(word => word.length < 21)
         var $predata = {};

         var sorting;
         if (!($("#sorting_order").hasClass("hidden"))) {
             let sort_text = $("#sorting").text()
             sorting = ($("#sorting_order").hasClass("glyphicon-triangle-top")) ? `+${sort_text}` : `-${sort_text}`
         }

         var tags = $.map($(".filter-selected"), x => x.innerText)

         if (Boolean(sorting)) {
             $predata['sorting'] = sorting.toString()
         }
         if (words.length > 0) {
             $predata['query'] = words
         }

         if (tags.length > 0) {
              $predata['tags'] = tags
         }

         var $data = $.param($predata, true)

         // console.log("typeof(data): ", typeof($data))

         $.ajax({
             method: "GET",
             url: '/ajax/yeet_cannon/',
             data: $data,
             dataType: 'html',
             success: yeet_cannon_success,
         });
     }

     function yeet_cannon_success(data) {
         $("#saved_list_container").html(data)
     }

    // function search_daddy() {
    //     var separator = /(?:\s|\,|\.)/
    //     var search_string = $("#search_bar").val()
    //     var words = search_string.split(separator).filter(Boolean)
    //
    //     var $data = $.param({ 'query': words }, true)
    //     // var $data = {'query': words }
    //     if (words.length == 0) {
    //         return false
    //     }
    //
    //     $.ajax({
    //         method: "GET",
    //         url: '/ajax/search_query/',
    //         data: $data,
    //         dataType: 'html',
    //         success: search_query_success,
    //         error: search_query_error,
    //     });
    // }

    // function search_query_success(data) {
    //     $("#saved_list_container").html(data)
    //     // console.log('data: ', data)
    // }
    //
    // function search_query_error(data) {
    //     notifyUser(data.message)
    // }


    function rate_saved_list(d) {
        var spec = (d.wow_class) ? 1 : 0
        var rating = d.rating
        var id = d.id
        $.ajax({
            method: "POST",
            url: '/ajax/save_rating/',
            data: {
                'value': rating,
                'id': id,
                'spec': spec,
            },
            dataType: 'json',
            success: update_rating,
            error: rating_error,
        });
    }

    function update_rating(data) {
        //
        var ratings_container;
        if (data.wow_class) {
            ratings_container = $(`div.ratings-container[data-id='${data.id}'][data-wowclass="${data.wow_class}"]`)
        } else {
            ratings_container = $(`div.ratings-container[data-id='${data.id}']`)
        }
        let width = data.average_rating*20

        var star_limiter = ratings_container.find("div.star-limiter")
        star_limiter.css('width', `${width}%`)

        var stars = ratings_container.find($(".glyphicon"))
        stars.unbind()
        stars.removeClass("glyphicon-star-empty").addClass("glyphicon-star")
        ratings_container.find("div.star-box").removeClass("rating-vote")
        ratings_container.find("div.star-bg").removeClass("rating-vote")
        ratings_container.find($(".ratings-count")).text(`(${data.num_ratings})`)

    }

    function rating_error(data) {
        notifyUser(data.message)
    }

    {% if request.user.is_staff %}

    $("a.remove-rating").on({
        click: e => {
            e.preventDefault()
            var target = $(e.target)

            var container = target.closest($(".ratings-container"))
            var id = container.attr("data-id")
            var wow_class = (container.attr("data-wowclass").length) ? container.attr("data-wowclass") : ''

            var data = {
                wow_class: wow_class,
                id: id,
            }
            delete_rating(data)

        }
    })

    function delete_rating(d) {
        var spec = (d.wow_class) ? true : false
        var id = d.id
        $.ajax({
            method: "POST",
            url: '/ajax/delete_rating/',
            data: {
                'id': id,
                'spec': spec,
            },
            dataType: 'json',
            success: delete_rating_success
        });
    }

    function delete_rating_success(data) {
        notifyUser(data.message)
    }
    {% endif %}


</script>
{% endblock javascript %}
