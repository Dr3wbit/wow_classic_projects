{% if recipes %}
{% load static %}

{% load titlecase from custom_filters %}

    {% for recipe,v in recipes.items %}
    <div class="row">
        <div class="col-8">
            <div class="prof-item-recipe" name="{{recipe}}">
                {% with "images/icons/consumes/"|add:recipe|add:".jpg" as item_image %}
                <span class="recipe-container {{v.rarity}}" name="{{recipe}}">
                <img class="icon-medium recipe-image" src="{% static "images/icon_border_2.png" %}"
                style="background-image: url({% static item_image %});">
                {% endwith %}
                <span class="consume-name" name="{{recipe}}">{{v.name|titlecase}}</span>
            </span>
            </div>
        </div>
        <div class="col-4 reagant-list">
            {% for mat_name,val in v.materials.items %}
            <div class="reagant-list-container" name="{{mat_name}}">
                <img class="icon-medium" src="{% static "images/icon_border_2.png" %}"
                {% if "eko" in mat_name %}
                style="background-image: url({% static "images/icons/medium/materials/eko.jpg" %});">
                {% else %}
                style="background-image: url({% static "images/icons/medium/materials/"|add:mat_name|add:".jpg" %});">
                {% endif %}
                {% if val.amount > 1 %}
                <span class="count-container">
                    <div class="material-count">{{val.amount}}</div>
                    <div class="material-count" style="color: black; bottom: 1px; z-index: 4;">{{val.amount}}</div>
                    <div class="material-count" style="color: rgba(0,0,0,.9); bottom: 3px; z-index: 4;">{{val.amount}}</div>
                    <div class="material-count" style="color: black; right: 3px; z-index: 4;">{{val.amount}}</div>
                </span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    <script src="{% static "js/consume_tool.js" %}"></script>
    <script>

    function update_consume_list(name, amount=1) {
        let prof = $("a.prof-filter.selected").attr("id")

        if (!my_consume_list[prof]) {
            my_consume_list[prof] = {}
        }

        let step = (allConsumes[name].step) ? allConsumes[name].step : 1

        if (!my_consume_list[prof][name]) {
            my_consume_list[prof][name] = amount*step
        }

        else {
            my_consume_list[prof][name] += amount*step
        }


        if (my_consume_list[prof][name] <= 0) {
            my_consume_list[prof][name] = 0
        }

        console.log(my_consume_list)

        // mats = allConsumes[name].materials
        //
        // for (let [k, v] of Object.entries(mats)) {
        //     if (!my_consume_list['materials'][k]) {
        //         my_consume_list['materials'][k] = 0
        //     }
        //     my_consume_list['materials'][k] = (my_consume_list['materials'][k]+v)
        // }

    }

    $(".consume-name").on({
        mouseenter: e => {
            clearTooltip()
            tooltip_v2(e)
        },
        mouseleave: e => {
            clearTooltip()
        },
        mousemove: e => {
            update_tooltip(e)
            // tooltip_v2(e, 'consume')
        },
    })

    $(".recipe-image").on({
        mouseenter: e=> {
            clearTooltip()
            let name = $(e.target).closest($(".recipe-container")).attr('name')
            updatetooltip(e, name, 'consume')
        },
        mouseleave: e => {
            clearTooltip()
        },

    })

    function tooltip_v2(e) {
    	const targetElement = $(e.target)
    	const name = targetElement.attr('name')

    	const thisObj = allConsumes[name]
    	const properName = (thisObj.name) ? thisObj.name : utilities.titleCase(name)
    	const rarity = thisObj.rarity
    	const tooltipElems = [{class: `title ${rarity}`, text: properName}]
    	if (thisObj.bop) {
    		tooltipElems.push({class: 'bop', text: "Binds when picked up",})
    	}
    	if (thisObj.unique) {
    		tooltipElems.push({class: 'unique', text: "Unique",})
    	}
    	let requirementText = ''
    	if (name == 'goblin_rocket_boots' || name == 'black_mageweave_boots') {
    		requirementText = thisObj.req
    	} else {
    		requirementText = (thisObj.req) ? ((thisObj.req.toString().startsWith('engi') || thisObj.req.toString().startsWith('first')) ? utilities.titleCase(thisObj.req.replace(/([a-zA-Z\_]+)(\d+)/, "$1 ($2)")) : `Requires Level ${thisObj.req}`) : false
    	}

    	if (thisObj.req || thisObj.stats) {
    		tooltipElems.push({class: 'requiredLevel', text: requirementText})
    	}
    	if (thisObj.use) {
    		tooltipElems.push({class: 'use', text: `Use: ${thisObj.use}`})
    	}
    	if (thisObj.description) {
    		tooltipElems.push({class: 'description', text: `"${thisObj.description}"`})
    	}
    	utilities_v2.bigdaddytooltip(e, tooltipElems)
    }

function update_tooltip(e) {
		let pageY = e.pageY
		let pageX = e.pageX+15
        const tooltip = $("#tooltip_container")
        tooltip.attr("style", `top: ${pageY}px; left: ${pageX}px; visiblity: visible;`)
}


    $(".prof-item-recipe").on({
        mousedown: e => {
            e.stopImmediatePropagation()
            var amount = 1
            let name = $(e.target).closest(".recipe-container").attr('name')
            if ((parseInt($(`span.crafted-container[name='${name}']`).find($('span.amount')).text())) >= 100) {
                return false
            }
            if (e.shiftKey) {
                amount = 5
            }

            if (e.which === 3) {
                amount = amount*(-1)
            }
            update_consume_list(name, amount)
            addCraftedItem(name, amount)
            update_url('', '')
        }
    })

    $(".reagant-list-container").on({
        mouseenter: e => {
            let name = $(e.target).closest(".reagant-list-container").attr('name')
            updatetooltip(e, name, 'material')
        },
        mouseleave: e => {
            clearTooltip()
        },
    });

    // $(".recipe-container").on({
    //     mouseenter: e => {
    //         clearTooltip()
    //         let target = $(e.target).closest(".recipe-container")
    //         // let name = $(e.target).closest(".recipe-container").attr('name')
    //
    //         updatetooltip(target, 'consume')
    //     },
    //     mouseleave: e => {
    //         clearTooltip()
    //     },
    //     mousemove: e => {
    //         clearTooltip()
    //
    //         updatetooltip($(e.target).closest(".recipe-container"), 'consume')
    //         // tooltip_v2(e, 'consume')
    //     },
    //     contextmenu: e => {
	// 		e.preventDefault()
	// 	},
    //     mousedown: e => {
    //         var amount = 1
    //         let name = $(e.target).closest(".recipe-container").attr('name')
    //         if ((parseInt($(`span.crafted-container[name='${name}']`).find($('span.amount')).text())) >= 100) {
    //             return false
    //         }
    //         if (e.shiftKey) {
    //             amount = 5
    //         }
    //
    //         if (e.which === 3) {
    //             amount = amount*(-1)
    //         }
    //         update_consume_list(name, amount)
    //         addCraftedItem(name, amount)
    //         update_url('', '')
    //     }
    //
    // });

    </script>
 {% endif %}
