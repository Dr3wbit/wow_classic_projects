{% load static %}
<div class="row">
    <div id="total_crafted" class="col-12">

    {% for c in cl.consumes.all %}
    <div class="crafted-list-item" name="{{c.name}}">
        <span class="crafted-container" role="button" name="{{c.name}}" href="#{{c.name}}_collapse"
            data-toggle="collapse" aria-expanded="false">
            <a class="btn btn-sm plus">
                <span class="glyphicon glyphicon-triangle-right" style="color: azure;"></span>
            </a>
            {% with "images/icons/consumes/"|add:c.name|add:".jpg" as item_image %}
            <img class="icon-small" src="{% static "images/icons/small/icon_border.png" %}"
                style="background-image: url({% static item_image %}); user-select:none; pointer-events:none;">
            {% endwith %}
            {% load titlecase from custom_filters %}
            <span class="crafted-name {{c.item.rarity}}" name="{{c.name}}">{{c.name|titlecase}}</span>
            <span>[</span><span class="amount">{{c.amount}}</span><span>]</span>
        </span>

        <div class="materials-list collapse" id="{{c.name}}_collapse">
            {% for mat in c.item.materials.all %}
            <div class="materials-list-item" name="{{mat.name}}">
                <span class="material-container" name="{{mat.name}}">
                    <img class="icon-small" src="{% static "images/icons/small/icon_border.png" %}"
                    {% if "eko" in mat.name %}
                        style="background-image: url({% static "images/icons/small/eko.jpg" %});">
                    {% else %}
                        style="background-image: url({% static "images/icons/small/"|add:mat.name|add:".jpg" %});">
                    {% endif %}

                    <span class="materials-name {{mat.rarity}}" name="{{mat.name}}">{{mat.name|titlecase}}</span>
                    <span>[</span><span class="amount">{% widthratio mat.amount 1 c.amount %}</span><span>]</span>
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
    <span id="separator" class="col-12">Totals</span>
    <div id="total_materials" class="col-12">
        {% for mat_name,v in materials.items %}
        <div class="materials-list-item" name="{{mat_name}}">
            <span class="material-container" name="{{mat_name}}">
                <img class="icon-small" src="{% static "images/icons/small/icon_border.png" %}"
                    style="background-image: url({% static "images/icons/small/"|add:mat_name|add:".jpg" %}); user-select:none; pointer-events:none;">
                    <span class="materials-name {{v.rarity}}" name="{{mat_name}}">{{mat_name|titlecase}}</span>
                    <span>[</span><span>{{v.value}}</span><span>]</span>
            </span>
        </div>
        {% endfor %}
    </div>
</div>
{{consumes|json_script:"hello-data"}}
<script>

$(document).ready(function() {
    load_event_handlers()
})

var my_consume_list = JSON.parse(document.getElementById('hello-data').textContent)
if (!my_consume_list) {
    my_consume_list = {}
}

function load_event_handlers() {
    $(".material-container").on({
        mouseenter: e => {
            clearTooltip()
            updatetooltip($(e.target).closest(".material-container"), 'material')
        },
        mouseleave: e => {
            clearTooltip()
        },

    });

    $(".crafted-container").on({
        mouseenter: e => {
            clearTooltip()
            tooltip_v2(e)
        },
        mouseleave: e => {
            clearTooltip()
        },
        mousemove: e => {
            update_tooltip(e)
        }
    });

    $(".materials-list").on({
        'shown.bs.collapse': e => {
            let id = $( e.target ).attr("id")
            $(`span.crafted-container[href="#${id}"]`).find('span.glyphicon').removeClass('glyphicon-triangle-right').addClass('glyphicon-triangle-bottom')
            // $(`span.crafted-container[name="${name}"]`).find('span.glyphicon').removeClass('glyphicon-triangle-right').addClass('glyphicon-triangle-bottom')
            // let targetID = $(e.target).attr('id').replace('_collapse', '')
        },
        'hidden.bs.collapse': e => {
            let id = $( e.target ).attr("id")
            $(`span.crafted-container[href="#${id}"]`).find('span.glyphicon').removeClass('glyphicon-triangle-bottom').addClass('glyphicon-triangle-right')
            // $(`span.crafted-container[name="${name}"]`).find('span.glyphicon').removeClass('glyphicon-triangle-bottom').addClass('glyphicon-triangle-right')
            // let targetID = $(e.target).attr('id').replace('_collapse', '')
        },
    });
}
function tooltip_v2(e) {
    const targetElement = $(e.target)
    const name = targetElement.attr('name')

    const thisObj = allConsumes[name]
    const properName = (thisObj.name) ? thisObj.name : utilities.titleCase(name)
    const rarity = thisObj.rarity
    const tooltipElems = [{class: `title ${rarity}`, text: properName}]
    if (thisObj.bop) {
        tooltipElems.push({class: 'bop', text: "Binds when picked up",})
    }
    if (thisObj.unique) {
        tooltipElems.push({class: 'unique', text: "Unique",})
    }
    let requirementText = ''
    if (name == 'goblin_rocket_boots' || name == 'black_mageweave_boots') {
        requirementText = thisObj.req
    } else {
        requirementText = (thisObj.req) ? ((thisObj.req.toString().startsWith('engi') || thisObj.req.toString().startsWith('first')) ? utilities.titleCase(thisObj.req.replace(/([a-zA-Z\_]+)(\d+)/, "$1 ($2)")) : `Requires Level ${thisObj.req}`) : false
    }

    if (thisObj.req || thisObj.stats) {
        tooltipElems.push({class: 'requiredLevel', text: requirementText})
    }
    if (thisObj.use) {
        tooltipElems.push({class: 'use', text: `Use: ${thisObj.use}`})
    }
    if (thisObj.description) {
        tooltipElems.push({class: 'description', text: `"${thisObj.description}"`})
    }
    utilities_v2.bigdaddytooltip(e, tooltipElems)
}

function update_tooltip(e) {
    let pageY = e.pageY
    let pageX = e.pageX+15
    const tooltip = $("#tooltip_container")
    tooltip.attr("style", `top: ${pageY}px; left: ${pageX}px; visiblity: visible;`)
}


</script>
